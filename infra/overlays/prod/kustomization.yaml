apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: prod

resources:
  - ../../base
  # Note: cert-manager.yaml (ClusterIssuer) should be applied separately as it's cluster-scoped
  # kubectl apply -f cert-manager.yaml

replicas:
  - name: backend
    count: 3
  - name: frontend
    count: 3

images:
  - name: bakeroni1/backend
    newTag: 1.1.0
  - name: bakeroni1/frontend
    newTag: 1.0.3

patchesStrategicMerge:
  - |-
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: backend-ingress
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        traefik.ingress.kubernetes.io/redirect-entry-point: "https"
    spec:
      tls:
        - hosts:
            - api.cluster.bakircinjarevic.com
          secretName: backend-tls
      rules:
        - host: api.cluster.bakircinjarevic.com
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: backend
                    port:
                      number: 3000
  - |-
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: frontend-ingress
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        traefik.ingress.kubernetes.io/redirect-entry-point: "https"
    spec:
      tls:
        - hosts:
            - cluster.bakircinjarevic.com
          secretName: frontend-tls
      rules:
        - host: cluster.bakircinjarevic.com
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: frontend
                    port:
                      number: 80
  - |-
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: frontend-config
    data:
      config.js: |
        window.APP_CONFIG = {
          backendUrl: "https://api.cluster.bakircinjarevic.com"
        };
  - |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: backend
    spec:
      template:
        spec:
          containers:
            - name: backend
              env:
                - name: DB_HOST
                  value: "postgresql-prod-rw.prod.svc.cluster.local"
                - name: DB_PORT
                  value: "5432"
                - name: DB_NAME
                  value: "appdb"
                - name: DB_USER
                  value: "appuser"
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-prod-credentials
                      key: password
